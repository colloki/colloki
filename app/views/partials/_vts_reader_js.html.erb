var VTSReader = {
  selectors: {
    channel: '.vts-reader'
  },

  events: {
    available : 'vtsAvailableEvent',
    read      : 'vtsReadEvent',
    stop      : 'vtsStopEvent',
    complete  : 'vtsCompleteEvent'
  },

  init: function() {
    var self      = this;
    $channels     = $(self.selectors.channel);

    $channels.bind(self.events.available, function(e) {
      console.log("VTS Reader: Availability message received!");
      $channels
      .removeClass('disabled')
      .bind('click', self.speak)
      .popover('disable')
      .tooltip();
    });

    $channels.bind(self.events.complete, function(e) {
      self.complete(e);
    });
  },

  speak: function(e) {
    e.preventDefault();
    var self = VTSReader;

    var $channel = $(e.target);
    if (!$channel.hasClass('btn')) {
      $channel = $channel.parent();
    }

    if ($channel.data('status') == 0) {
      self.sendReadMessage($channel.get(0));
      self.setToStop($channel);
    }

    else {
      self.sendStopMessage(e.target);
      self.setAllToRead();
    }
  },

  complete: function(e) {
    var self = VTSReader;
    self.setAllForRead();
  },

  sendStopMessage: function(channel) {
    console.log("VTS Reader: Sending stop message...");
    this.sendMessage(channel, this.events.stop);
  },

  sendReadMessage: function(channel) {
    console.log("VTS Reader: Sending read message...");
    this.sendMessage(channel, this.events.read);
  },

  sendMessage: function(channel, message) {
    var customEvent = document.createEvent('Event');
    customEvent.initEvent(message, true, true);
    channel.dispatchEvent(customEvent);
  },

  // ui
  setAllToRead: function() {
    $(this.selectors.channel)
    .attr('data-original-title', 'Listen to this story')
    .removeClass('btn-danger')
    .addClass('btn-success')
    .data('status', 0);
  },

  setToStop: function($channel) {
    this.setAllToRead();

    $channel
    .attr('data-original-title', 'Stop listening')
    .removeClass('btn-success')
    .addClass('btn-danger')
    .data('status', 1);
  }
}

$(document).ready(function(e) {
  VTSReader.init();
});
