<%= form_for :discuss, :html => {:multipart => true}, :url => discuss_path do |f| %>
  <div class="row-fluid">
    <div class="pull-left">
      <h4>Take a Photo</h4>
      <%= f.file_field :photo, :class => "choose-photo" %>
    </div>
    <div class="photo-container pull-right"></div>
  </div>
  <div class="control-group">
    <div class="controls">
      <%= f.text_field :title,
        :placeholder => "Give it a title...",
        :class => "span8 post-title"
      %>
    </div>
  </div>

  <%= f.hidden_field :topic, :value => -1 %>
  <div class="form-actions">
    <button type="submit" class="btn btn-success">
      Post
    </button>
  </div>

<% end %>

<script>
$(document).ready(function() {
  $(".choose-photo").on('change', function(evt) {
    var files = evt.target.files; // FileList object

    // Loop through the FileList and render image files as thumbnails.
    for (var i = 0, f; f = files[i]; i++) {

      // Only process image files.
      if (!f.type.match('image.*')) {
        continue;
      }

      var reader = new FileReader();

      // Closure to capture the file information.
      reader.onload = (function(theFile) {
        return function(e) {
          // Render thumbnail.
          var $photo = $('.photo-container');
          $photo.html(['<img class="thumb" src="', e.target.result,
                      '" title="', escape(theFile.name), '"/>'].join(''))
          setTimeout(function() {
            $('.post-title').focus();
          }, 100);
        };
      })(f);

      // Read in the image file as a data URL.
      reader.readAsDataURL(f);
    }
  });
});
</script>
